# Инструкция по созданию новых таблиц в проекте с использованием Alembic

В данном файле представлена вспомогательная информация при работе над проектом. 
Для полной информации по работе с Alembic, следует обращаться к [официальной документации](https://alembic.sqlalchemy.org/).

## Шаг 1: Создание ORM модели

После разработки новой ORM модели с использованием SQLAlchemy, например:

Файл: `openvair/modules/block_device/adapters/orm.py`

```python
"""ORM models of the block device module"""

import uuid

from sqlalchemy import Table, Column, String, MetaData
from sqlalchemy.orm import registry
from sqlalchemy.dialects import postgresql

metadata = MetaData()
mapper_registry = registry(metadata=metadata)

iscsi_interfaces = Table(
    'iscsi_interfaces',
    mapper_registry.metadata,
    Column(
        'id',
        postgresql.UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
    ),
    Column('inf_type', String(20)),
    Column('ip', String(40), unique=True),
    Column('port', String(20), nullable=True),
    Column('status', String(20)),
)


class ISCSIInterface:
    """ORM model for iscsi_interfaces table"""

    pass


def start_mappers() -> None:
    """Start mapping ORM models to tables on db for the block device module"""
    mapper_registry.map_imperatively(ISCSIInterface, iscsi_interfaces)
```

## Шаг 2: Добавление модели в конфигурацию Alembic
Для того чтобы Alembic мог отслеживать изменения в новой модели, необходимо импортировать соответствующий ORM модуль в скрипт openvair/alembic/env.py и добавить его метаданные в target_metadata.

В скрипт env.py добавляем следующие строки:

```python
from openvair.modules.block_device.adapters import orm as orm_block_device
```
Также в массив target_metadata добавляем метаданные нового модуля:

```python
target_metadata = [
    ...,
    orm_block_device.mapper_registry.metadata,
]
```

## Шаг 3: Генерация миграции
Для создания новой миграции с помощью Alembic, необходимо выполнить следующую команду в терминале, при активированной виртуальной среде проекта:

```bash
~/openvair$ alembic revision -m "create_block_device" --rev-id 2 --autogenerate
```

- Флаг -m отвечает за имя python скрипта создания и удаления таблицы
- Флаг --rev-id за идентификатор номера миграции. В проекте принято их нумеровать последовательно, начиная с еденицы. Соответственно если актуальный id миграции например 4, то в --rev-id передаём 5.
- Флаг --autogenerate обеспечивает что Alembic генерирует скрипт для создания и удаления таблицы самостоятельно, сверяясь с orm.py файлами проекта. Без него, функции внутри создаваемого скрипта будут не реалзованы и содержать в своём теле pass

После успешного выполнения команды будет создан файл миграции openvair/alembic/versions/2_create_block_device.py, который будет содержать все изменения в ORM моделях, которые указаны в target_metadata файла env.py. В данном случае изменения касаются только новой таблицы для модуля блочных устройств.

Важно убедиться что функции сгенерировались корректно содержат в себе актуальные изменения связанные с таблицей

Пример:
```python
"""create_block_device

Revision ID: 2
Revises: 1
Create Date: 2024-08-12 16:19:22.530565

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = '2'
down_revision = '1'
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('iscsi_interfaces',
    sa.Column('id', postgresql.UUID(as_uuid=True), nullable=False),
    sa.Column('inf_type', sa.String(length=20), nullable=True),
    sa.Column('ip', sa.String(length=40), nullable=True),
    sa.Column('port', sa.String(length=20), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('ip')
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('iscsi_interfaces')
    # ### end Alembic commands ###

```

## Шаг 4: Применение миграции
Для применения новой миграции выполните команду:

```bash
~/openvair$ alembic upgrade head
```

Эта команда применит все актуальные изменения к базе данных. Alembic обновит идентификатор ревизии в таблице Alembic и выполнит скрипт создания новой таблицы.

## Важные замечания

- **Добавление модели в env.py:** При создании нового модуля, важно сразу же после создания файла orm.py добавить его в env.py. Только после этого можно выполнять команды Alembic для генерации и применения миграций.
- **Избегайте ручного создания таблиц:** Никогда не создавайте таблицы вручную, если в этом нет крайней необходимости. В случае особенностей таблиц, убедитесь, что модель базы данных спроектирована корректно. Ручное создание таблиц может привести к несоответствию между ORM моделью и реальной структурой базы данных, что может вызвать ошибки при дальнейшем использовании Alembic.
- **Итоговое состояние новой таблицы приводите к одному файлу:** В ходе разработки модуля, возникает необходимость добавления или удаления полей. Пока функционал находится и разрабатывается в отдельной ветке, решение о том как изменять структуру таблицы остаётся за разработчиком. Но при подготовке к слиянию с основными ветками проекта разработчик должен с нуля создать скрипт миграции(следуя данной инструкции), основываясь на итоговом состоянии orm модели. И уже в итоговом виде оформлять pull request

Следование данным рекомендациям поможет избежать ошибок при работе с миграциями и обеспечит целостность и актуальность структуры базы данных.



