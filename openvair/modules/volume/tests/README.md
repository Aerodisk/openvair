# Тесты модуля `volume`

---

## Цели тестов

- Проверка поведения публичных API-эндпоинтов модуля `volume`
- Обнаружение и предотвращение регрессий при изменениях
- Поддержание актуальности бизнес-логики
- Документирование допустимого и недопустимого поведения
- Упрощение рефакторинга и внедрения новых фич

---

## Подход к тестированию

Тесты реализованы как **интеграционные**:
- Взаимодействуют с API через `TestClient`
- Используют реальные RPC-вызовы (RabbitMQ)
- Работают с реальной БД и файловой системой (`qemu-img`, `libvirt`)

Покрытие:
- Все основные CRUD-операции
- Позитивные и негативные кейсы
- Ошибки валидации, бизнес-правила и исключения RPC

---

## Инфраструктура

- `pytest` + `fastapi.testclient`
- `pydantic` для формирования входных данных
- `uuid`, `sqlalchemy`, `time.sleep()` — для управления состоянием
- Конфигурация через `.env.test` + `pydantic-settings`
- Данные удаляются после каждого теста

---

## Структура файлов

```
tests/
│
├── api/
│   ├── test_create.py     # POST /volumes/create/
│   ├── test_delete.py     # DELETE /volumes/{id}/
│   ├── test_edit.py       # PUT /volumes/{id}/edit/
│   ├── test_extend.py     # POST /volumes/{id}/extend/
│   ├── test_retrieve.py   # GET /volumes/, /volumes/{id}/
│
├── conftest.py            # Общие фикстуры и подготовка окружения
├── config.py              # Pydantic-конфигурация тестовой среды
├── .env.test              # Переменные среды (TEST_STORAGE_PATH и др.)
├── pytest.ini             # Конфигурация порядка запуска, логирования
```

---

## Фикстуры

- `test_storage`: создаёт и удаляет `storage` через API
- `test_volume`: создаёт и удаляет `volume` через API
- `attached_volume`: добавляет фиктивную привязку тома к VM в БД
- `mock_auth_dependency`: подмена JWT-аутентификации
- `cleanup_all_volumes`: удаление томов через доменную логику

---

## Покрытие эндпоинтов

| Эндпоинт                                 | Назначение                                | Статус   |
|------------------------------------------|--------------------------------------------|----------|
| `POST /volumes/create/`                  | Создание тома                              | ✅ покрыт |
| `GET /volumes/`                          | Список томов с фильтрами и пагинацией      | ✅ покрыт |
| `GET /volumes/{volume_id}/`             | Получение тома по ID                       | ✅ покрыт |
| `PUT /volumes/{volume_id}/edit/`        | Редактирование метаданных                  | ✅ покрыт |
| `POST /volumes/{volume_id}/extend/`     | Расширение размера                         | ✅ покрыт |
| `DELETE /volumes/{volume_id}/`          | Удаление тома                              | ✅ покрыт |
| `POST /volumes/{volume_id}/attach/`     | Привязка к VM                              | ⏳ не реализовано |
| `DELETE /volumes/{volume_id}/detach/`   | Отвязка от VM                              | ⏳ не реализовано |

---

## Запуск тестов

```bash
cd openvair/modules/volume/tests/
pytest -v
```

Можно задать уровень логирования и порядок запуска через `pytest.ini`.

---

## Примечания

- Все тесты используют `TestClient` и реальные RPC-вызовы через `RabbitMQ`
- Перед запуском требуется настроенное окружение: PostgreSQL, RabbitMQ, файловая директория (`/dev/vdb`)
- Используется `test_storage` c `localfs`, который создаётся и удаляется в каждом запуске
- Все тесты изолированы и не зависят от порядка выполнения