# üß™ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é API –≤ OpenVair

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –µ–¥–∏–Ω—ã–π –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –Ω–∞–ø–∏—Å–∞–Ω–∏—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –¥–ª—è API-–º–æ–¥—É–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞ OpenVair. –û–Ω –ø–æ–¥—Ö–æ–¥–∏—Ç –∫–∞–∫ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö, —Ç–∞–∫ –∏ –¥–ª—è –Ω–æ–≤—ã—Ö –º–æ–¥—É–ª–µ–π.

---

## üéØ –û–±—â–∏–µ —Ü–µ–ª–∏ –∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### –¶–µ–ª–∏

1. ‚úÖ –ü–æ–≤—ã—à–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ.
2. üìò –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è API —á–µ—Ä–µ–∑ —Ç–µ—Å—Ç—ã.
3. üß† –§–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –∏ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π.
4. ‚ôªÔ∏è –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ ‚Äî —Ç–µ—Å—Ç—ã –≤—ã—è–≤–ª—è—é—Ç –ø–æ–ª–æ–º–∫–∏.
5. üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, –æ—à–∏–±–æ–∫, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π.

### –ü—Ä–∏–Ω—Ü–∏–ø—ã

- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã** —á–µ—Ä–µ–∑ `TestClient` FastAPI.
- **–§–∏–∫—Å—Ç—É—Ä—ã** —É–ø—Ä–∞–≤–ª—è—é—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º —Å—É—â–Ω–æ—Å—Ç–µ–π (`volume`, `storage`, –∏ —Ç.–¥.).
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –º–æ–∫–∏ ‚Äî –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ (RabbitMQ, –ë–î, RPC).
- –¢–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è **—Ä–µ–∞–ª—å–Ω–æ–µ API**, –∫–∞–∫ –æ–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º –∏–ª–∏ –¥—Ä—É–≥–∏–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏.
- –ü–æ–≤–µ–¥–µ–Ω–∏–µ API –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è **–Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤, –æ—à–∏–±–æ–∫ –∏ –ø–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤**.

---

## üìã –ü–æ–¥—Ö–æ–¥ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–æ–¥—É–ª–µ–π

1. üîç **–ê–Ω–∞–ª–∏–∑ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏**:
   - –†–∞–∑–±–æ—Ä API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤.
   - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥—É–ª—è–º–∏, side-effects.

2. üóÇ **–°–±–æ—Ä –∫–æ–¥–∞**:
   - –°–æ–±–∏—Ä–∞—é—Ç—Å—è —Ñ–∞–π–ª—ã: schemas, api, crud, service, domain, rpc, exceptions.
   - –ò–∑—É—á–∞–µ—Ç—Å—è –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –≤—ã–∑–æ–≤–∞ –æ—Ç API –¥–æ –¥–æ–º–µ–Ω–Ω–æ–≥–æ —Å–ª–æ—è.

3. ‚úçÔ∏è **–§–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è**:
   - –û–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ –∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏.
   - –û–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è, –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è.

4. ‚úÖ **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤**:
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ –ø–∏—à–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª —Ç–µ—Å—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `test_create.py`).
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π `test_*` —Å –ø–æ–Ω—è—Ç–Ω—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º.

5. üîÑ **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã**:
   - –°–æ–∑–¥–∞—é—Ç—Å—è `test_storage`, `test_volume`, `attached_volume` –∏ –¥—Ä.
   - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è cleanup, mock auth, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è pagination.

6. üß™ **–ó–∞–ø—É—Å–∫ –∏ –æ—Ç–ª–∞–¥–∫–∞**:
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤.
   - –ü–æ–∏—Å–∫ flaky-—Ç–µ—Å—Ç–æ–≤.
   - –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ.

---

## üß© –ü–æ–¥—Ö–æ–¥ –¥–ª—è –Ω–æ–≤—ã—Ö –º–æ–¥—É–ª–µ–π

1. üîç –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –∏ —Å—Ö–µ–º (–¥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏).
2. ‚úçÔ∏è –ù–∞–ø–∏—Å–∞–Ω–∏–µ TDD-—Å—Ç–∏–ª—è —Ç–µ—Å—Ç–æ–≤ **–¥–æ –∫–æ–¥–∞**.
3. üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –∫–∞–∫ "–∫—Ä–∞—Å–Ω—ã—Ö", —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω—É–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏.
4. üîÅ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å –æ–ø–æ—Ä–æ–π –Ω–∞ —Ç–µ—Å—Ç—ã.
5. üìà –î–æ–±–∞–≤–ª–µ–Ω–∏–µ edge-–∫–µ–π—Å–æ–≤, –æ—à–∏–±–æ–∫, –≤–∞–ª–∏–¥–∞—Ü–∏–∏.

---

## üìÅ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤

```
openvair/
  modules/
    <module_name>/
      tests/
        api/
          test_create.py
          test_delete.py
          test_edit.py
          test_extend.py
          test_retrieve.py
        conftest.py
        config.py
        .env.test
```

---

## üîß Pytest –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```
# openvair/modules/<module>/tests/pytest.ini
[pytest]
log_cli = true
log_cli_level = DEBUG
addopts = --order-scope=module
```

---

## ‚úÖ –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Pydantic-—Å—Ö–µ–º `CreateVolume` –≤ —Ç–µ—Å—Ç–∞—Ö.
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `status_code`, —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –æ—Ç–≤–µ—Ç–∞, –±–∏–∑–Ω–µ—Å-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.
- –í—ã–¥–µ–ª–µ–Ω–∏–µ id —Ç–æ–º–∞/—Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —á–µ—Ä–µ–∑ —Ñ–∏–∫—Å—Ç—É—Ä—ã –∏ –æ—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ.

---

## üìå –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –§–∏–∫—Å—Ç—É—Ä—ã –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –≥–∏–±–∫–∏–º–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–º–µ–Ω–∞ —á–µ—Ä–µ–∑ `uuid4().hex[:6]`.
- –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ‚Äî –¥–æ–ø—É—Å—Ç–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `unit_of_work` –∏ –∑–∞–ø–∏—Å—å –Ω–∞–ø—Ä—è–º—É—é –≤ –ë–î.
- –°—Ç–æ—Ä–æ–Ω–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã (RabbitMQ) –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Å—Ä–µ–¥–µ CI/CD.

---

## üß© –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫

- **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã:** –æ—à–∏–±–∫–∏ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç (`error_code`, `message`, `details`).
- **–ö–æ–¥—ã –æ—à–∏–±–æ–∫:** –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ HTTP-—Å—Ç–∞—Ç—É—Å—ã (`400`, `409`, `500`) –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏—Ö.
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** –∑–∞–≤–µ–¥–∏—Ç–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –æ—à–∏–±–æ–∫ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏.

---

### –ò–∑–æ–ª—è—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è

- **–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã:** –≤–º–µ—Å—Ç–æ Docker –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –í–ú —Å KVM/libvirt –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ä–µ–¥–µ.

---

### –û–±—Ä–∞–±–æ—Ç–∫–∞ flaky-—Ç–µ—Å—Ç–æ–≤

- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ:** –≤–º–µ—Å—Ç–æ `time.sleep` –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `wait_for_status(...)` —Å —Ç–∞–π–º–∞—É—Ç–æ–º.
- **–ü–æ–≤—Ç–æ—Ä –∑–∞–ø—É—Å–∫–∞:** `pytest-rerunfailures` –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–µ—Å—Ç—ã –ø—Ä–∏ —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–±–æ—è—Ö.
- **–ò–∑–æ–ª—è—Ü–∏—è:** —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–µ—Å—Ç—ã –Ω–µ –≤–ª–∏—è—é—Ç –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞ (—Ñ–∏–∫—Å—Ç—É—Ä—ã, –æ—á–∏—Å—Ç–∫–∞).
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –Ω–∞ —Å–ª—É—á–∞–π –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

---

### –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

- **–ï–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å:** —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `tests/api/test_*.py` –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö –º–æ–¥—É–ª—è—Ö.
- **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ—Å—Ç—å:** —Ñ–∏–∫—Å—Ç—É—Ä—ã –∏ —É—Ç–∏–ª–∏—Ç—ã –æ–±—â–∏–µ, —Ä–∞—Å—à–∏—Ä—è—é—Ç—Å—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

---

### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å—Ä–µ–¥—ã

- –ó–∞–ø—É—Å–∫–∞–π—Ç–µ —Ç–µ—Å—Ç—ã –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏, –ø—Ä–∏–±–ª–∏–∂–µ–Ω–Ω–æ–º –∫ –ø—Ä–æ–¥–∞–∫—à–Ω (–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã, —Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏).
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ `.env.test` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–æ–¥—É–ª—è.
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `pydantic-settings` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:
  ```
  TEST_STORAGE_PATH=/dev/vdb
  TEST_STORAGE_FS_TYPE=ext4
  ```